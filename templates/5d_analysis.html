{% extends "base.html" %}

{% block title %}5D Analysis - {{ project.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i data-feather="layers"></i> 5D Schedule Analysis</h2>
                <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-secondary">
                    <i data-feather="arrow-left"></i> Back to Project
                </a>
            </div>
            
            <div class="card analysis-card mb-4">
                <div class="card-header analysis-header">
                    <h5>Analysis Configuration</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-4">
                                {{ form.analysis_type.label(class="form-label") }}
                                {{ form.analysis_type(class="form-select") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.include_3d_model.label(class="form-label") }}
                                {{ form.include_3d_model(class="form-select") }}
                            </div>
                            <div class="col-md-4">
                                {{ form.time_period.label(class="form-label") }}
                                {{ form.time_period(class="form-select") }}
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
            
            {% if analysis_data %}
            <!-- Time Performance Analysis -->
            {% if analysis_data.get('time_performance') %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="clock"></i> Time Performance Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-primary">{{ "%.2f"|format(analysis_data.time_performance.schedule_performance_index) }}</h3>
                                <p class="text-muted">Schedule Performance Index</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-info">{{ analysis_data.time_performance.total_duration }} days</h3>
                                <p class="text-muted">Total Duration</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-success">{{ "%.1f"|format(analysis_data.time_performance.completed_duration) }} days</h3>
                                <p class="text-muted">Completed Duration</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-warning">{{ "%.1f"|format(analysis_data.time_performance.remaining_duration) }} days</h3>
                                <p class="text-muted">Remaining Duration</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Cost Performance Analysis -->
            {% if analysis_data.get('cost_performance') %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="dollar-sign"></i> Cost Performance Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h4 class="text-primary">${{ "{:,.2f}"|format(analysis_data.cost_performance.planned_value) }}</h4>
                                        <p class="text-muted">Planned Value (PV)</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h4 class="text-success">${{ "{:,.2f}"|format(analysis_data.cost_performance.earned_value) }}</h4>
                                        <p class="text-muted">Earned Value (EV)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h4 class="text-warning">${{ "{:,.2f}"|format(analysis_data.cost_performance.actual_cost) }}</h4>
                                        <p class="text-muted">Actual Cost (AC)</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h4 class="{% if analysis_data.cost_performance.cost_performance_index >= 1 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(analysis_data.cost_performance.cost_performance_index) }}
                                        </h4>
                                        <p class="text-muted">Cost Performance Index</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="text-center">
                                <h5 class="{% if analysis_data.cost_performance.cost_variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "{:,.2f}"|format(analysis_data.cost_performance.cost_variance) }}
                                </h5>
                                <p class="text-muted">Cost Variance (CV)</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <h5 class="{% if analysis_data.cost_performance.schedule_variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "{:,.2f}"|format(analysis_data.cost_performance.schedule_variance) }}
                                </h5>
                                <p class="text-muted">Schedule Variance (SV)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Resource Utilization Analysis -->
            {% if analysis_data.get('resource_utilization') %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="users"></i> Resource Utilization Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-primary">{{ "%.1f"|format(analysis_data.resource_utilization.utilization_percentage) }}%</h3>
                                <p class="text-muted">Utilization Rate</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-info">{{ analysis_data.resource_utilization.total_crew_hours }}</h3>
                                <p class="text-muted">Total Crew Hours</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-success">{{ "%.1f"|format(analysis_data.resource_utilization.utilized_crew_hours) }}</h3>
                                <p class="text-muted">Utilized Hours</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-warning">{{ analysis_data.resource_utilization.peak_resource_demand }}</h3>
                                <p class="text-muted">Peak Resource Demand</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Spatial Conflicts Analysis -->
            {% if analysis_data.get('spatial_conflicts') %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="alert-triangle"></i> Spatial Conflicts Analysis</h5>
                </div>
                <div class="card-body">
                    {% if analysis_data.spatial_conflicts %}
                        <div class="alert alert-warning">
                            <h6>{{ analysis_data.spatial_conflicts|length }} Spatial Conflicts Detected</h6>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Activity 1</th>
                                        <th>Activity 2</th>
                                        <th>Conflict Type</th>
                                        <th>Severity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for conflict in analysis_data.spatial_conflicts %}
                                    <tr>
                                        <td>{{ conflict.activity1 }}</td>
                                        <td>{{ conflict.activity2 }}</td>
                                        <td>{{ conflict.type|title }}</td>
                                        <td>
                                            <span class="badge {% if conflict.severity == 'high' %}bg-danger{% elif conflict.severity == 'medium' %}bg-warning{% else %}bg-info{% endif %}">
                                                {{ conflict.severity|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <h6>No Spatial Conflicts Detected</h6>
                            <p class="mb-0">All activities appear to be properly sequenced without location conflicts.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Productivity Analysis -->
            {% if analysis_data.get('productivity_analysis') %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="trending-up"></i> Productivity Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-primary">{{ "%.2f"|format(analysis_data.productivity_analysis.average_productivity) }}</h3>
                                <p class="text-muted">Average Productivity</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-success">{{ analysis_data.productivity_analysis.high_performing_activities }}</h3>
                                <p class="text-muted">High Performing Activities</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-danger">{{ analysis_data.productivity_analysis.underperforming_activities }}</h3>
                                <p class="text-muted">Underperforming Activities</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-info">{{ "%.3f"|format(analysis_data.productivity_analysis.productivity_variance) }}</h3>
                                <p class="text-muted">Productivity Variance</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Risk Assessment -->
            {% if analysis_data.get('risk_assessment') %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i data-feather="shield"></i> Risk Assessment</h5>
                </div>
                <div class="card-body">
                    {% if analysis_data.risk_assessment %}
                        {% for risk in analysis_data.risk_assessment %}
                        <div class="alert {% if risk.severity == 'high' %}alert-danger{% elif risk.severity == 'medium' %}alert-warning{% else %}alert-info{% endif %}">
                            <h6>{{ risk.type|title }} Risk</h6>
                            <p class="mb-0">{{ risk.description }}</p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-success">
                            <h6>Low Risk Project</h6>
                            <p class="mb-0">No significant risks identified in the current schedule analysis.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}